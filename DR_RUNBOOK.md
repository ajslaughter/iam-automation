# Disaster Recovery Runbook

## Bare-metal recovery

1. Restore the most recent system state backup created by `src\Scripts\Backup\Invoke-ADBackup.ps1` using Windows Server Backup or `wbadmin start systemstaterecovery`.
2. Reboot into Directory Services Restore Mode (DSRM) if prompted and follow Microsoft guidance for authoritative/non-authoritative restores.
3. After the system state completes, verify Active Directory services and SYSVOL availability with `src\Scripts\Health\Test-LabHealth.ps1`.

## Authentication service validation

1. Confirm DNS forwarders and replication using `Test-LabHealth.ps1`.
2. Run `dsacls`/`dcdiag` as needed to validate domain controller health.
3. Review the backup log stored beside each system state backup (`SystemState-<Server>-<Timestamp>.txt`).

## Rehydrating directory objects

1. Import the latest configuration snapshot generated by `src\Scripts\Backup\Export-ConfigSnapshot.ps1`:

```powershell
$snapshotPath = Get-ChildItem .\backups -Filter 'config-snapshot.json' -Recurse | Sort-Object LastWriteTime -Descending | Select-Object -First 1
$snapshot = Get-Content $snapshotPath.FullName -Raw | ConvertFrom-Json
```

2. Recreate missing OUs:

```powershell
foreach ($ou in $snapshot.OrganizationalUnits) {
    if (-not (Get-ADOrganizationalUnit -Identity $ou.DistinguishedName -ErrorAction SilentlyContinue)) {
        New-ADOrganizationalUnit -Name $ou.Name -Path ($ou.DistinguishedName -replace '^OU=[^,]+,')
    }
}
```

3. Rehydrate groups and memberships:

```powershell
foreach ($group in $snapshot.Groups) {
    if (-not (Get-ADGroup -Identity $group.Name -ErrorAction SilentlyContinue)) {
        New-ADGroup -Name $group.Name -GroupScope $group.GroupScope -GroupCategory $group.GroupCategory -Path 'OU=Groups,DC=corp,DC=local'
    }
    if ($snapshot.GroupPolicyAssignments) {
        # group membership hydration
        $members = $snapshot.Users | Where-Object { $_.SamAccountName -in $group.Members }
        foreach ($member in $members) {
            Add-ADGroupMember -Identity $group.Name -Members $member.SamAccountName -ErrorAction SilentlyContinue
        }
    }
}
```

4. Restore user attributes (display name, title, etc.) by iterating through `$snapshot.Users` and calling `Set-ADUser`.
5. Reapply GPO links by looping through `$snapshot.GroupPolicyAssignments` and calling `New-GPLink` for each entry.

## Post-recovery tasks

- Run `Invoke-DriftReport.ps1` to confirm that the recovered environment matches the desired configuration.
- Re-register the IamLab JEA endpoint and SecretManagement vault if they were hosted on the recovered server.
- Capture a new system state backup and configuration snapshot once validation succeeds.
